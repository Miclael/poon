<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>機台故障回報</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="max-w-3xl mx-auto p-4 sm:p-6">
    <!-- 標題 -->
    <header class="mb-4">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">機台故障回報</h1>
      <p class="text-gray-600 mt-1">填寫表單 → 產生訊息卡片 → 一鍵複製 / 分享 LINE / 刪除</p>
    </header>

    <!-- 表單 -->
    <section class="bg-white rounded-2xl shadow p-5 sm:p-6 space-y-4">
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">廠別</label>
          <select id="factory" class="w-full border rounded-lg p-2.5">
            <option value="P1">P1</option>
            <option value="P5">P5</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">機台</label>
          <input id="machine" type="text" placeholder="例如：機台3" class="w-full border rounded-lg p-2.5">
        </div>

        <div class="sm:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">故障原因</label>
          <input id="reason" type="text" placeholder="例如：Sensor Error" class="w-full border rounded-lg p-2.5">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">處理狀態</label>
          <select id="status" class="w-full border rounded-lg p-2.5">
            <option value="未處理">未處理</option>
            <option value="已修復">已修復</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">故障時間</label>
          <input id="time" type="datetime-local" class="w-full border rounded-lg p-2.5">
          <div class="flex flex-wrap gap-2 mt-2">
            <button data-shift="-15" class="timeShift px-2 py-1 text-xs rounded bg-gray-200 hover:bg-gray-300">-15 分</button>
            <button data-shift="-5" class="timeShift px-2 py-1 text-xs rounded bg-gray-200 hover:bg-gray-300">-5 分</button>
            <button data-shift="-1" class="timeShift px-2 py-1 text-xs rounded bg-gray-200 hover:bg-gray-300">-1 分</button>
            <button id="nowBtn" class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 hover:bg-blue-200">現在</button>
            <button data-shift="1" class="timeShift px-2 py-1 text-xs rounded bg-gray-200 hover:bg-gray-300">+1 分</button>
            <button data-shift="5" class="timeShift px-2 py-1 text-xs rounded bg-gray-200 hover:bg-gray-300">+5 分</button>
            <button data-shift="15" class="timeShift px-2 py-1 text-xs rounded bg-gray-200 hover:bg-gray-300">+15 分</button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">偏移（分鐘）</label>
          <input id="offset" type="number" value="0" class="w-full border rounded-lg p-2.5" />
        </div>

        <div class="sm:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
          <textarea id="note" rows="2" placeholder="可填寫描述/處置方式/聯絡人"
            class="w-full border rounded-lg p-2.5"></textarea>
        </div>
      </div>

      <div class="flex gap-3 pt-2">
        <button id="addBtn"
          class="flex-1 sm:flex-none sm:w-40 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg">
          ➕ 新增回報
        </button>
        <button id="clearBtn"
          class="flex-1 sm:flex-none sm:w-40 bg-gray-200 hover:bg-gray-300 text-gray-900 font-medium py-2.5 rounded-lg">
          清空表單
        </button>
      </div>
    </section>

    <!-- 清單 -->
    <section class="mt-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-bold">回報清單</h2>
        <input id="search" type="search" placeholder="搜尋：廠別/機台/原因/備註" class="border rounded-lg p-2 text-sm w-60">
      </div>
      <div id="messageContainer" class="space-y-3"></div>
      <p id="emptyHint" class="text-gray-500 text-sm mt-3 hidden">目前沒有資料，請先新增回報。</p>
    </section>
  </div>

  <script>
    // 工具
    function pad(n){return String(n).padStart(2,'0')}
    function toDatetimeLocalValue(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`}
    function fromDatetimeLocalValue(val){if(!val)return null;const[date,time]=val.split('T');const[y,m,d]=date.split('-').map(Number);const[hh,mm]=time.split(':').map(Number);return new Date(y,m-1,d,hh,mm)}
    function formatForMessage(d){return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`}
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]))}

    // 狀態
    let messages = JSON.parse(localStorage.getItem('messages') || '[]')
    const timeInput=document.getElementById('time')
    timeInput.value=toDatetimeLocalValue(new Date())

    // 時間快捷
    document.getElementById('nowBtn').addEventListener('click',()=>{timeInput.value=toDatetimeLocalValue(new Date())})
    document.querySelectorAll('.timeShift').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const shift=+btn.dataset.shift
        const base=fromDatetimeLocalValue(timeInput.value)||new Date()
        base.setMinutes(base.getMinutes()+shift)
        timeInput.value=toDatetimeLocalValue(base)
      })
    })

    const f=factory,m=machine,r=reason,s=status,o=offset,n=note
    document.getElementById('addBtn').addEventListener('click',()=>{
      const factory=f.value.trim(),machine=m.value.trim(),reason=r.value.trim(),status=s.value,note=n.value.trim(),offset=+o.value||0
      let t=fromDatetimeLocalValue(timeInput.value)||new Date()
      t.setMinutes(t.getMinutes()+offset)
      if(!factory||!machine||!reason){alert('請填寫完整資訊');return}
      messages.unshift({factory,machine,reason,status,timeISO:t.toISOString(),note})
      saveAndRender()
      clearForm()
    })
    document.getElementById('clearBtn').addEventListener('click',clearForm)
    document.getElementById('search').addEventListener('input',renderMessages)

    function clearForm(){m.value='';r.value='';s.value='未處理';n.value='';o.value=0}
    function saveAndRender(){localStorage.setItem('messages',JSON.stringify(messages));renderMessages()}

    function renderMessages(){
      const list=messageContainer,hint=emptyHint,q=search.value.toLowerCase().trim()
      list.innerHTML=''
      const filtered=messages.filter(msg=>!q||[msg.factory,msg.machine,msg.reason,msg.status,msg.note||''].join(' ').toLowerCase().includes(q))
      hint.classList.toggle('hidden',filtered.length>0)
      filtered.forEach((msg,i)=>{
        const t=new Date(msg.timeISO)
        const statusClass=msg.status==='已修復'?'bg-green-500':'bg-red-500'
        const card=document.createElement('div')
        card.className='bg-white border border-gray-200 rounded-2xl shadow p-4 sm:p-5'
        card.innerHTML=`
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="flex items-center gap-2">
                <h3 class="text-lg sm:text-xl font-bold">${escapeHtml(msg.factory)} - ${escapeHtml(msg.machine)}</h3>
                <span class="text-xs px-2 py-1 rounded text-white ${statusClass}">${escapeHtml(msg.status)}</span>
              </div>
              <div class="text-sm text-gray-700 mt-1">⚠️ ${escapeHtml(msg.reason)}</div>
              <div class="text-xs text-gray-500 mt-1">🕒 ${formatForMessage(t)}</div>
              ${msg.note?`<div class="text-sm text-gray-600 mt-2">📝 ${escapeHtml(msg.note)}</div>`:''}
            </div>
            <div class="flex flex-col sm:flex-row gap-2 shrink-0">
              <button class="px-3 py-1.5 text-sm rounded bg-blue-600 hover:bg-blue-700 text-white" data-action="copy" data-index="${i}">複製</button>
              <button class="px-3 py-1.5 text-sm rounded bg-green-500 hover:bg-green-600 text-white" data-action="line" data-index="${i}">LINE</button>
              <button class="px-3 py-1.5 text-sm rounded bg-gray-200 hover:bg-gray-300 text-gray-900" data-action="delete" data-index="${i}">刪除</button>
            </div>
          </div>`
        list.appendChild(card)
      })
      list.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click',cardAction))
    }

    function cardAction(e){
      const a=e.currentTarget.dataset.action
      const i=+e.currentTarget.dataset.index
      if(a==='copy') copyMsg(i)
      if(a==='delete'){messages.splice(i,1);saveAndRender()}
      if(a==='line') shareLine(i)
    }
    function copyMsg(i){
      const m=messages[i]
      const txt=`[${m.factory}-${m.machine}] ${m.reason} (${formatForMessage(new Date(m.timeISO))}) 狀態:${m.status}${m.note?'\n備註:'+m.note:''}`
      navigator.clipboard.writeText(txt).then(()=>toast('已複製'))
    }
    function shareLine(i){
      const m=messages[i]
      const txt=`[${m.factory}-${m.machine}] ${m.reason} (${formatForMessage(new Date(m.timeISO))}) 狀態:${m.status}${m.note?'\n備註:'+m.note:''}`
      window.open(`https://line.me/R/msg/text/?${encodeURIComponent(txt)}`,'_blank')
    }
    function toast(msg){
      const el=document.createElement('div')
      el.textContent=msg
      el.className='fixed left-1/2 -translate-x-1/2 bottom-6 bg-black text-white text-sm px-3 py-1.5 rounded-lg opacity-0 transition-opacity'
      document.body.appendChild(el)
      requestAnimationFrame(()=>el.classList.remove('opacity-0'))
      setTimeout(()=>{el.classList.add('opacity-0');setTimeout(()=>el.remove(),300)},1200)
    }

    renderMessages()
  </script>
</body>
</html>