<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>我的網站收藏（行動版｜長按編輯）</title>
<style>
  :root{
    --bg:#f7f7f9; --card:#fff; --text:#222; --muted:#666; --line:#e5e7eb;
    --accent:#2563eb; --danger:#dc2626; --radius:14px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif;-webkit-tap-highlight-color:transparent}
  .wrap{max-width:960px;margin:0 auto;padding:16px 12px 48px}
  h1{font-size:20px;margin:0 0 10px}
  .hint{font-size:12px;color:var(--muted);margin-bottom:12px}

  /* 表單（手機優先） */
  .form{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px;display:grid;gap:10px;position:sticky;top:0;z-index:5}
  .row{display:grid;gap:8px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:560px){ .row-2{grid-template-columns:1fr} }
  label{font-size:12px;color:var(--muted)}
  input[type="text"],input[type="url"]{
    width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;font-size:16px;box-sizing:border-box
  }
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:12px 16px;border:1px solid var(--line);background:#fff;border-radius:999px;font-size:15px;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.ghost{background:#fff}
  .msg{font-size:12px;color:var(--muted);min-height:1em}

  /* 卡片清單（觸控大面積） */
  .grid{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (min-width:680px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (min-width:960px){ .grid{grid-template-columns:repeat(4,1fr)} }

  .card{
    position:relative;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    padding:12px;display:flex;flex-direction:column;gap:10px;touch-action:manipulation
  }
  .card[aria-disabled="true"]{opacity:.6;pointer-events:none}

  .preview{
    width:100%;aspect-ratio:1/1;border-radius:12px;overflow:hidden;border:1px solid var(--line);
    background:linear-gradient(135deg,#eef2ff,#f5f5f5);display:flex;align-items:center;justify-content:center
  }
  .preview .favicon{width:42%;height:42%;object-fit:contain;image-rendering:-webkit-optimize-contrast}
  .preview .initial{
    position:absolute;inset:auto 6px 6px auto;background:rgba(0,0,0,.08);border-radius:6px;padding:4px 6px;
    font-weight:700;font-size:12px
  }
  .name{font-weight:700;line-height:1.25;font-size:15px}
  .url{font-size:12px;color:var(--muted);word-break:break-all}

  /* 長按選單（覆蓋於卡片上） */
  .menu-mask{position:absolute;inset:0;background:rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center}
  .menu{
    background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.18);
    padding:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:92%
  }
  .menu button{border-radius:12px;padding:10px 14px}
  .menu .danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .menu .primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .menu .ghost{background:#fff}

  /* 對話框（編輯） */
  dialog{border:1px solid var(--line);border-radius:16px;padding:0;max-width:96vw;width:420px}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .dlg-hd{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:700}
  .dlg-bd{padding:12px 14px;display:grid;gap:10px}
  .dlg-ft{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

  /* 其他 */
  .sr-only{position:absolute;left:-9999px}
  .empty{font-size:14px;color:var(--muted);text-align:center;padding:18px}
  .card[role="link"]{cursor:pointer}
  .card:focus-visible{outline:3px solid rgba(37,99,235,.35)}
</style>
</head>
<body>
<div class="wrap">
  <h1>我的網站收藏</h1>
  <div class="hint">手機操作：<b>點一下</b>卡片開網站；<b>長按</b>卡片出現選單，按「編輯」直接彈出對話框（不會開網頁）。</div>

  <!-- 新增表單 -->
  <form class="form" id="siteForm" autocomplete="off">
    <div class="row-2">
      <div>
        <label for="name">站名稱</label>
        <input id="name" name="name" type="text" placeholder="例如：OpenAI" required />
      </div>
      <div>
        <label for="url">連結（可貼完整網址或不含 http(s)）</label>
        <input id="url" name="url" type="url" placeholder="例如：openai.com 或 https://openai.com" required />
      </div>
    </div>
    <div class="btns">
      <button type="submit" class="primary">新增</button>
      <button type="button" class="ghost" id="exportBtn" title="匯出 JSON 備份">匯出</button>
      <button type="button" class="ghost" id="importBtn" title="從 JSON 匯入">
        <span aria-hidden="true">匯入</span>
        <input class="sr-only" type="file" id="importFile" accept="application/json" />
      </button>
      <span class="msg" id="msg"></span>
    </div>
  </form>

  <!-- 清單 -->
  <div id="siteList" class="grid" role="list" aria-label="網站清單"></div>
  <div id="emptyState" class="empty" hidden>目前沒有資料，先從上方新增一筆吧。</div>
</div>

<!-- 編輯對話框（預設聚焦名稱；可同時改連結） -->
<dialog id="editDialog" aria-labelledby="editTitle">
  <div class="dlg-hd" id="editTitle">編輯網站</div>
  <form method="dialog" id="editForm">
    <div class="dlg-bd">
      <div>
        <label for="editName">站名稱</label>
        <input id="editName" type="text" required />
      </div>
      <div>
        <label for="editUrl">連結（可留空不改）</label>
        <input id="editUrl" type="url" placeholder="不變更可留空" />
      </div>
    </div>
    <div class="dlg-ft">
      <button type="submit" class="primary">儲存</button>
      <button type="button" id="editCancel" class="ghost">取消</button>
    </div>
  </form>
</dialog>

<script>
/* ============================================================
   行動版網站收藏 – 長按編輯（不開網頁）
   - 點擊卡片：新分頁開啟網站
   - 長按卡片（~500~600ms）：顯示選單（編輯/刪除/取消）
   - 選「編輯」：直接打開編輯對話框（只改名稱或同時改連結）
   - localStorage 永續化；匯入/匯出 JSON
   - 防誤觸：長按後當次點擊不會開網站
   ============================================================ */
(function(){
  "use strict";

  // ===== DOM =====
  const $form       = document.getElementById('siteForm');
  const $name       = document.getElementById('name');
  const $url        = document.getElementById('url');
  const $list       = document.getElementById('siteList');
  const $empty      = document.getElementById('emptyState');
  const $msg        = document.getElementById('msg');
  const $exportBtn  = document.getElementById('exportBtn');
  const $importBtn  = document.getElementById('importBtn');
  const $importFile = document.getElementById('importFile');

  const $editDlg    = document.getElementById('editDialog');
  const $editForm   = document.getElementById('editForm');
  const $editName   = document.getElementById('editName');
  const $editUrl    = document.getElementById('editUrl');
  const $editCancel = document.getElementById('editCancel');

  const STORAGE_KEY = 'siteBook.v1';

  // ===== 資料存取 =====
  function loadSites(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      console.warn('讀取失敗，重置空清單', e);
      return [];
    }
  }
  function saveSites(list){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }catch(e){
      alert('儲存失敗：可能超出瀏覽器儲存限制。'); console.error(e);
    }
  }
  function normalizeUrl(input){
    let s = (input || '').trim();
    if(!s) throw new Error('請輸入網址');
    if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
    const u = new URL(s);
    return u.toString();
  }
  function displayHost(href){ try{ return new URL(href).host; }catch{ return href; } }
  function faviconUrl(href){ try{ const u=new URL(href); return u.origin + '/favicon.ico'; }catch{ return ''; } }
  function findIndexById(list, id){ return list.findIndex(x=>x.id===id); }
  function toggleEmpty(show){ $empty.hidden = !show; }
  function toast(text){
    $msg.textContent = text || '';
    if(!text) return;
    setTimeout(()=>{ $msg.textContent=''; }, 1800);
  }

  // ===== 卡片渲染 =====
  function createCard(site){
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = site.id;
    card.setAttribute('role','link');
    card.setAttribute('tabindex','0');
    card.setAttribute('aria-label', `開啟 ${site.name}`);

    // 預覽方塊
    const pvBox = document.createElement('div'); pvBox.className = 'preview';
    const img = document.createElement('img');
    img.className = 'favicon'; img.alt = '';
    img.decoding = 'async'; img.referrerPolicy = 'no-referrer';
    img.src = faviconUrl(site.url);
    img.addEventListener('error',()=>{ img.remove(); });
    const init = document.createElement('div'); init.className = 'initial';
    init.textContent = (site.name || '?').trim().charAt(0).toUpperCase();
    pvBox.appendChild(img); pvBox.appendChild(init);

    const name = document.createElement('div'); name.className='name'; name.textContent = site.name;
    const url  = document.createElement('div'); url.className='url';  url.textContent  = displayHost(site.url);

    card.appendChild(pvBox); card.appendChild(name); card.appendChild(url);

    // 1) 輕點：開網站（若剛長按，不開）
    card.addEventListener('click', (e)=>{
      if(card.dataset.longpress === '1'){
        e.preventDefault(); e.stopPropagation();
        card.dataset.longpress = '0';
        return;
      }
      try{ window.open(site.url, '_blank','noopener'); }catch{}
    });
    // 2) 鍵盤 Enter：開網站
    card.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ try{ window.open(site.url, '_blank','noopener'); }catch{} }
    });

    // 3) 長按 & 右鍵（桌機）：打開動作選單
    bindLongPress(card, site);
    card.addEventListener('contextmenu', (e)=>{
      e.preventDefault(); showActionMenu(card, site);
    });

    return card;
  }

  function render(list){
    $list.innerHTML = '';
    if(!list.length){ toggleEmpty(true); return; }
    toggleEmpty(false);
    const frag = document.createDocumentFragment();
    list.forEach(site => frag.appendChild(createCard(site)));
    $list.appendChild(frag);
  }

  // ===== 長按偵測（手機）=====
  function bindLongPress(card, site){
    let timer = null, startX = 0, startY = 0;
    const HOLD = 550; // ms：可依喜好 450~650
    function clearTimer(){ if(timer){ clearTimeout(timer); timer=null; } }
    function onDown(e){
      startX = e.clientX ?? 0; startY = e.clientY ?? 0;
      card.dataset.longpress = '0';
      clearTimer();
      timer = setTimeout(()=>{
        card.dataset.longpress = '1';
        try{ navigator.vibrate?.(15); }catch{}
        showActionMenu(card, site);
      }, HOLD);
      try{ card.setPointerCapture?.(e.pointerId); }catch{}
    }
    function onMove(e){
      const dx = Math.abs((e.clientX??0)-startX), dy = Math.abs((e.clientY??0)-startY);
      if(dx>8 || dy>8) clearTimer();
    }
    function onUp(){ clearTimer(); }
    card.addEventListener('pointerdown', onDown, {passive:true});
    card.addEventListener('pointermove', onMove, {passive:true});
    card.addEventListener('pointerup', onUp, {passive:true});
    card.addEventListener('pointercancel', onUp);
    card.addEventListener('pointerleave', onUp);
  }

  // ===== 動作選單（覆蓋於卡片上）=====
  function showActionMenu(card, site){
    closeActionMenu(card);
    const mask = document.createElement('div'); mask.className='menu-mask'; mask.setAttribute('role','dialog');
    const menu = document.createElement('div'); menu.className='menu';

    const btnEdit = document.createElement('button'); btnEdit.className='primary'; btnEdit.type='button'; btnEdit.textContent='編輯';
    btnEdit.addEventListener('click', ()=>{ closeActionMenu(card); onEdit(site.id); });

    const btnDel = document.createElement('button'); btnDel.className='danger'; btnDel.type='button'; btnDel.textContent='刪除';
    btnDel.addEventListener('click', ()=>{ closeActionMenu(card); onDelete(site.id, site.name); });

    const btnCancel = document.createElement('button'); btnCancel.className='ghost'; btnCancel.type='button'; btnCancel.textContent='取消';
    btnCancel.addEventListener('click', ()=> closeActionMenu(card));

    menu.appendChild(btnEdit); menu.appendChild(btnDel); menu.appendChild(btnCancel);
    mask.appendChild(menu);
    mask.addEventListener('click', (e)=>{ if(e.target===mask) closeActionMenu(card); });
    card.appendChild(mask);

    // 避免長按後的「點擊」立刻開網站
    setTimeout(()=>{ card.dataset.longpress = '0'; }, 0);
  }
  function closeActionMenu(card){
    const m = card.querySelector('.menu-mask'); if(m) m.remove();
  }

  // ===== 編輯／刪除 =====
  let editingId = null;

  function onEdit(id){
    const sites = loadSites();
    const idx = findIndexById(sites, id);
    if(idx < 0) return alert('找不到此筆資料');
    const item = sites[idx];

    editingId = id;
    $editName.value = item.name;
    $editUrl.value  = ''; // 預設空白＝不改連結
    $editDlg.showModal();
    setTimeout(()=> $editName.focus(), 50);
  }

  $editCancel.addEventListener('click', ()=> $editDlg.close());

  $editForm.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    try{
      if(!editingId) throw new Error('未知的編輯項目');
      const newName = ($editName.value || '').trim();
      const urlInput = ($editUrl.value || '').trim();
      if(!newName) throw new Error('請輸入站名稱');

      let newUrl = null;
      if(urlInput){ newUrl = normalizeUrl(urlInput); } // 有填才更新連結

      if(!confirm('確定要儲存修改嗎？')) return;

      const sites = loadSites();
      const idx = findIndexById(sites, editingId);
      if(idx < 0) throw new Error('找不到此筆資料');

      sites[idx] = { ...sites[idx], name: newName, ...(newUrl ? {url:newUrl}:{}), updatedAt: Date.now() };
      saveSites(sites); render(sites);
      $editDlg.close(); toast('已更新');
    }catch(err){
      alert('編輯失敗：' + (err?.message || err));
    }
  });

  function onDelete(id, name){
    if(!confirm(`確定要刪除「${name}」嗎？`)) return;
    const sites = loadSites();
    const idx = findIndexById(sites, id);
    if(idx < 0) return alert('找不到此筆資料');
    sites.splice(idx,1); saveSites(sites); render(sites); toast('已刪除');
  }

  // ===== 匯入／匯出 =====
  $exportBtn.addEventListener('click', ()=>{
    try{
      const sites = loadSites();
      const blob = new Blob([JSON.stringify(sites, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'sitebook.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('已匯出 JSON');
    }catch(e){ alert('匯出失敗：' + e); }
  });
  $importBtn.addEventListener('click', ()=> $importFile.click());
  $importFile.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0]; if(!file) return;
    try{
      const text = await file.text(); const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('格式錯誤');
      if(!confirm('匯入會覆蓋目前清單，確定要繼續嗎？')) return;
      const cleaned = arr.map(x=>({
        id: x.id || crypto.randomUUID(),
        name: String(x.name || '').trim().slice(0,100),
        url: (()=>{ try{ return normalizeUrl(x.url); }catch{ return 'https://example.com'; } })(),
        createdAt: Number(x.createdAt || Date.now())
      }));
      saveSites(cleaned); render(cleaned); toast('已匯入');
    }catch(err){ alert('匯入失敗：' + (err?.message || err)); }
    finally{ e.target.value = ''; }
  });

  // ===== 新增 =====
  $form.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    try{
      const name = ($name.value || '').trim();
      const url  = normalizeUrl($url.value);
      if(!name) throw new Error('請輸入站名稱');

      const sites = loadSites();
      if(sites.some(s=>s.url===url)){
        if(!confirm('清單中已有相同連結，仍要新增一筆嗎？')) return;
      }
      const site = { id: crypto.randomUUID(), name, url, createdAt: Date.now() };
      sites.unshift(site); saveSites(sites); render(sites);
      $form.reset(); toast('已新增');
    }catch(err){ alert('新增失敗：' + (err?.message || err)); }
  });

  // ===== 初始化 =====
  render(loadSites());
})();
</script>
</body>
</html>