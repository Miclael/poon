<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>我的網站收藏（可新增/編輯/刪除 + 小方格預覽）</title>
<style>
  /* ===== 基本樣式（Mobile-first）===== */
  :root{
    --bg:#f7f7f9;
    --card:#ffffff;
    --text:#222;
    --muted:#666;
    --line:#e5e7eb;
    --accent:#2563eb;
    --danger:#dc2626;
    --ok:#16a34a;
    --radius:14px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC",sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:16px 12px 48px;}
  h1{font-size:20px;margin:0 0 12px;}
  .hint{font-size:12px;color:var(--muted);margin-bottom:12px}

  /* ===== 表單區 ===== */
  .form{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    padding:12px;display:grid;grid-template-columns:1fr;gap:8px;position:sticky;top:0.5rem;z-index:10;
  }
  .row{display:grid;grid-template-columns:1fr;gap:8px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"], input[type="url"]{
    width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font-size:16px;box-sizing:border-box;
  }
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  button{
    padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:999px;font-size:14px;cursor:pointer;
  }
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.ghost{background:#fff}
  button.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .msg{font-size:12px;color:var(--muted);min-height:1em}

  /* ===== 清單卡片 ===== */
  .grid{
    margin-top:14px;
    display:grid;grid-template-columns:1fr 1fr;gap:12px;
  }
  @media (min-width:680px){ .grid{grid-template-columns:repeat(3,1fr);} }
  @media (min-width:980px){ .grid{grid-template-columns:repeat(4,1fr);} }

  .card{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    padding:10px;display:flex;flex-direction:column;gap:8px;
  }
  .preview{
    position:relative;width:100%;aspect-ratio:1/1;border-radius:10px;overflow:hidden;
    background:linear-gradient(135deg,#eef2ff,#f5f5f5);display:flex;align-items:center;justify-content:center;
    border:1px solid var(--line);
  }
  .preview .favicon{width:42%;height:42%;object-fit:contain;image-rendering:-webkit-optimize-contrast}
  .preview .initial{
    position:absolute;inset:auto 6px 6px auto;background:rgba(0,0,0,.08);
    border-radius:6px;padding:4px 6px;font-weight:700;font-size:12px
  }
  .name{font-weight:700;line-height:1.2}
  .url{font-size:12px;color:var(--muted);word-break:break-all}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .card a.open{
    text-decoration:none;color:inherit;outline:0;border:0;
  }
  .card .open:focus-visible{box-shadow:0 0 0 3px rgba(37,99,235,.35);border-radius:8px}

  /* ===== 對話框（編輯） ===== */
  dialog{
    border:1px solid var(--line);border-radius:16px;padding:0;max-width:96vw;width:420px;
  }
  dialog::backdrop{background:rgba(0,0,0,.3)}
  .dlg-hd{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:700}
  .dlg-bd{padding:12px 14px;display:grid;gap:10px}
  .dlg-ft{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}

  /* ===== 無障礙與狀態 ===== */
  .sr-only{position:absolute;left:-9999px}
  .empty{font-size:14px;color:var(--muted);text-align:center;padding:18px}
</style>
</head>
<body>
<div class="wrap">
  <h1>我的網站收藏</h1>
  <div class="hint">提示：輸入「站名稱」與「連結」，按「新增」。卡片上方的小方格會嘗試顯示該站的 <code>favicon.ico</code>；點卡片即可在新分頁開啟。</div>

  <!-- ===== 新增表單 ===== -->
  <form class="form" id="siteForm" autocomplete="off">
    <div class="row-2">
      <div>
        <label for="name">站名稱</label>
        <input id="name" name="name" type="text" placeholder="例如：OpenAI" required />
      </div>
      <div>
        <label for="url">連結（可貼上完整網址或不含 http(s)）</label>
        <input id="url" name="url" type="url" placeholder="例如：openai.com 或 https://openai.com" required />
      </div>
    </div>
    <div class="btns">
      <button type="submit" class="primary" id="addBtn">新增</button>
      <button type="button" class="ghost" id="exportBtn" title="匯出 JSON 備份">匯出</button>
      <button type="button" class="ghost" id="importBtn" title="從 JSON 匯入"><span aria-hidden="true">匯入</span><input class="sr-only" type="file" id="importFile" accept="application/json" /></button>
      <span class="msg" id="msg"></span>
    </div>
  </form>

  <!-- ===== 清單區 ===== -->
  <div id="siteList" class="grid" role="list" aria-label="網站清單"></div>
  <div id="emptyState" class="empty" hidden>目前沒有資料，先從上方新增一筆吧。</div>
</div>

<!-- ===== 編輯對話框 ===== -->
<dialog id="editDialog" aria-labelledby="editTitle">
  <div class="dlg-hd" id="editTitle">編輯網站</div>
  <form method="dialog" id="editForm">
    <div class="dlg-bd">
      <div>
        <label for="editName">站名稱</label>
        <input id="editName" type="text" required />
      </div>
      <div>
        <label for="editUrl">連結</label>
        <input id="editUrl" type="url" required />
      </div>
    </div>
    <div class="dlg-ft">
      <button type="submit" class="primary">儲存</button>
      <button type="button" id="editCancel" class="ghost">取消</button>
    </div>
  </form>
</dialog>

<script>
/* ============================================================
   網站收藏 – 純前端（localStorage 持久化）
   功能：
   - 新增 / 編輯 / 刪除（帶確認）
   - 小方格「預覽」使用 favicon（origin + /favicon.ico），失敗會顯示站名首字
   - 點擊卡片可新分頁開啟該站（安全 rel 屬性）
   - 匯入 / 匯出 JSON 備份
   無外部套件、行動優先、事件使用 addEventListener、資料以 data-* 綁定
   ============================================================ */

(function(){
  "use strict";

  // ===== 選擇器（穩定使用 data-* 或 id）
  const $form       = document.getElementById('siteForm');
  const $name       = document.getElementById('name');
  const $url        = document.getElementById('url');
  const $list       = document.getElementById('siteList');
  const $empty      = document.getElementById('emptyState');
  const $msg        = document.getElementById('msg');
  const $exportBtn  = document.getElementById('exportBtn');
  const $importBtn  = document.getElementById('importBtn');
  const $importFile = document.getElementById('importFile');

  const $editDlg    = document.getElementById('editDialog');
  const $editForm   = document.getElementById('editForm');
  const $editName   = document.getElementById('editName');
  const $editUrl    = document.getElementById('editUrl');
  const $editCancel = document.getElementById('editCancel');

  const STORAGE_KEY = 'siteBook.v1';

  /** 讀取資料 */
  function loadSites(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      console.warn('讀取失敗，重置空清單', e);
      return [];
    }
  }

  /** 儲存資料 */
  function saveSites(list){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }catch(e){
      alert('儲存失敗：可能超出瀏覽器儲存限制。');
      console.error(e);
    }
  }

  /** 正規化 URL（自動補 https://） */
  function normalizeUrl(input){
    let s = (input || '').trim();
    if(!s) throw new Error('請輸入網址');
    if(!/^https?:\/\//i.test(s)){ s = 'https://' + s; }
    // 檢查合法性
    const u = new URL(s);
    return u.toString();
  }

  /** 取網域 (顯示用) */
  function displayHost(href){
    try{ return new URL(href).host; }catch{ return href; }
  }

  /** 產生 favicon 位置（使用 origin + /favicon.ico）*/
  function faviconUrl(href){
    try{
      const u = new URL(href);
      return u.origin + '/favicon.ico';
    }catch{
      return '';
    }
  }

  /** 以 ID 尋找索引 */
  function findIndexById(list, id){
    return list.findIndex(x => x.id === id);
  }

  /** 空狀態切換 */
  function toggleEmpty(show){
    $empty.hidden = !show;
  }

  /** 短訊息（1.8 秒清除） */
  function toast(text){
    $msg.textContent = text || '';
    if(!text) return;
    setTimeout(()=>{ $msg.textContent=''; }, 1800);
  }

  /** 建立卡片 DOM */
  function createCard(site){
    const card = document.createElement('div');
    card.className = 'card';
    card.setAttribute('role','listitem');
    card.dataset.id = site.id;

    // ===== 預覽（方形）=====
    const preview = document.createElement('a');
    preview.className = 'open';
    preview.href = site.url;
    preview.target = '_blank';
    preview.rel = 'noopener noreferrer';
    preview.setAttribute('aria-label', `開啟 ${site.name}`);
    const pvBox = document.createElement('div');
    pvBox.className = 'preview';
    const img = document.createElement('img');
    img.className = 'favicon';
    img.alt = '';
    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';
    img.src = faviconUrl(site.url);

    // 如果載入失敗，用首字母方塊當作 fallback
    img.addEventListener('error',()=>{
      img.remove();
    });
    const init = document.createElement('div');
    init.className = 'initial';
    init.textContent = (site.name || '?').trim().charAt(0).toUpperCase();

    pvBox.appendChild(img);
    pvBox.appendChild(init);
    preview.appendChild(pvBox);
    card.appendChild(preview);

    // ===== 名稱與網址 =====
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = site.name;

    const url = document.createElement('div');
    url.className = 'url';
    url.textContent = displayHost(site.url);

    card.appendChild(name);
    card.appendChild(url);

    // ===== 操作鈕 =====
    const actions = document.createElement('div');
    actions.className = 'actions';

    const btnEdit = document.createElement('button');
    btnEdit.type = 'button';
    btnEdit.className = 'ghost';
    btnEdit.textContent = '編輯';
    btnEdit.addEventListener('click', () => onEdit(site.id));

    const btnDel = document.createElement('button');
    btnDel.type = 'button';
    btnDel.className = 'danger';
    btnDel.textContent = '刪除';
    btnDel.addEventListener('click', () => onDelete(site.id, site.name));

    actions.appendChild(btnEdit);
    actions.appendChild(btnDel);
    card.appendChild(actions);

    return card;
  }

  /** 渲染清單（批次更新 DOM） */
  function render(list){
    // 清空
    $list.innerHTML = '';
    if(!list.length){
      toggleEmpty(true);
      return;
    }
    toggleEmpty(false);

    const frag = document.createDocumentFragment();
    list.forEach(site => frag.appendChild(createCard(site)));
    $list.appendChild(frag);
  }

  // ===== 事件：新增 =====
  $form.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    try{
      const name = ($name.value || '').trim();
      const url  = normalizeUrl($url.value);

      if(!name) throw new Error('請輸入站名稱');

      const sites = loadSites();

      // 防呆：避免相同網址重複
      if(sites.some(s => s.url === url)){
        if(!confirm('清單中已有相同連結，仍要新增一筆嗎？')) return;
      }

      const site = {
        id: crypto.randomUUID(),
        name, url,
        createdAt: Date.now()
      };
      sites.unshift(site);
      saveSites(sites);
      render(sites);

      // 清表單並提示
      $form.reset();
      toast('已新增');
    }catch(err){
      alert('新增失敗：' + (err?.message || err));
    }
  });

  // ===== 事件：匯出（JSON）=====
  $exportBtn.addEventListener('click', ()=>{
    try{
      const sites = loadSites();
      const blob = new Blob([JSON.stringify(sites, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sitebook.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast('已匯出 JSON');
    }catch(e){
      alert('匯出失敗：' + e);
    }
  });

  // ===== 事件：匯入（JSON）=====
  $importBtn.addEventListener('click', ()=>{
    $importFile.click();
  });
  $importFile.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('格式錯誤');

      // 確認覆蓋
      if(!confirm('匯入會覆蓋目前清單，確定要繼續嗎？')) return;

      // 基本清洗
      const cleaned = arr.map(x => ({
        id: x.id || crypto.randomUUID(),
        name: String(x.name || '').trim().slice(0,100),
        url:  (()=>{ try{return normalizeUrl(x.url);}catch{return 'https://example.com';} })(),
        createdAt: Number(x.createdAt || Date.now())
      }));
      saveSites(cleaned);
      render(cleaned);
      toast('已匯入');
    }catch(err){
      alert('匯入失敗：' + (err?.message || err));
    }finally{
      e.target.value = '';
    }
  });

  // ===== 編輯流程（dialog + 確認）=====
  let editingId = null;

  function onEdit(id){
    const sites = loadSites();
    const idx = findIndexById(sites, id);
    if(idx < 0) return alert('找不到此筆資料');

    const item = sites[idx];
    editingId = id;
    $editName.value = item.name;
    $editUrl.value  = item.url;
    $editDlg.showModal();
    // 聚焦
    setTimeout(()=> $editName.focus(), 50);
  }

  $editCancel.addEventListener('click', ()=> $editDlg.close());

  $editForm.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    try{
      if(!editingId) throw new Error('未知的編輯項目');
      const name = ($editName.value || '').trim();
      const url  = normalizeUrl($editUrl.value);
      if(!name) throw new Error('請輸入站名稱');

      if(!confirm('確定要儲存修改嗎？')) return;

      const sites = loadSites();
      const idx = findIndexById(sites, editingId);
      if(idx < 0) throw new Error('找不到此筆資料');

      sites[idx] = {
        ...sites[idx],
        name, url,
        updatedAt: Date.now()
      };
      saveSites(sites);
      render(sites);
      $editDlg.close();
      toast('已更新');
    }catch(err){
      alert('編輯失敗：' + (err?.message || err));
    }
  });

  // ===== 刪除流程（確認）=====
  function onDelete(id, name){
    if(!confirm(`確定要刪除「${name}」嗎？`)) return;
    const sites = loadSites();
    const idx = findIndexById(sites, id);
    if(idx < 0) return alert('找不到此筆資料');
    sites.splice(idx, 1);
    saveSites(sites);
    render(sites);
    toast('已刪除');
  }

  // ===== 初始化：載入並渲染 =====
  render(loadSites());
})();
</script>
</body>
</html>